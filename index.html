<!DOCTYPE html>
<html lang="pt-BR" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>B√∫ssola | Consultor Digital E.E. Ermelino Matarazzo</title>
    
    <!-- External Libs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Configura√ß√£o Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        slate: { 850: '#151F32' }
                    },
                    animation: {
                        'in': 'fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'spin-slow': 'spin 12s linear infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* Base & Reset */
        body { 
            background-color: #F1F5F9; /* Slate-100 */
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            transition: background-color 0.3s ease;
        }
        
        .dark body {
            background-color: #0F172A; /* Slate-900 */
            color: #F8FAFC;
        }

        /* Glassmorphism Utilities - Adaptive */
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .dark .glass-panel {
            background: rgba(15, 23, 42, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .dark .glass-header {
            background: rgba(15, 23, 42, 0.85);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.7); /* Slate-800 with opacity */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* iOS-style Interactions */
        .touch-card {
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s ease;
        }
        .touch-card:active { transform: scale(0.96); }

        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Typography Polish */
        .text-balance { text-wrap: balance; }
        
        /* Markdown Styles within Chat/Editor */
        .prose p { margin-bottom: 0.75em; font-size: 0.95rem; line-height: 1.5; }
        .prose strong { font-weight: 700; color: inherit; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.75em; }

        /* Map Styles */
        #map { height: 100%; width: 100%; border-radius: 1.5rem; z-index: 10; }
        .map-wrapper { height: 60vh; position: relative; border-radius: 1.5rem; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="text-slate-800 dark:text-slate-200 h-screen flex flex-col overflow-hidden selection:bg-blue-100 selection:text-blue-900">

    <!-- HEADER (Sticky Top) -->
    <header class="fixed top-0 left-0 right-0 z-50 px-6 pt-safe-top pb-4 h-20 glass-header flex items-center justify-between transition-all duration-300">
        <div class="flex items-center gap-3 cursor-pointer group" onclick="app.goHome()">
            <!-- Bussola Logo Refined (SVG) -->
            <div class="w-10 h-10 relative transition-transform group-hover:scale-105">
                <svg viewBox="0 0 200 200" fill="none" class="w-full h-full drop-shadow-md">
                    <circle cx="100" cy="100" r="90" class="fill-white dark:fill-slate-800 stroke-slate-200 dark:stroke-slate-700" stroke-width="2"/>
                    <circle cx="100" cy="100" r="82" class="stroke-slate-300 dark:stroke-slate-600" stroke-width="1" stroke-dasharray="4 4"/>
                    <!-- Needle -->
                    <path d="M100 40 L115 100 L100 160 L85 100 Z" class="fill-slate-800 dark:fill-slate-200"/>
                    <circle cx="100" cy="100" r="6" fill="#F59E0B"/>
                </svg>
            </div>
            <div class="flex flex-col">
                <h1 class="font-black text-lg leading-none tracking-tight text-slate-900 dark:text-white">B√öSSOLA</h1>
                <span class="text-[9px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest mt-0.5">E.E. Ermelino Matarazzo</span>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <!-- Theme Toggle -->
            <button onclick="app.toggleTheme()" class="w-10 h-10 rounded-full bg-white dark:bg-slate-800 text-slate-600 dark:text-yellow-400 flex items-center justify-center shadow-sm border border-slate-200 dark:border-slate-700 hover:scale-105 transition-transform">
                <i id="theme-icon" class="ph ph-moon-fill text-lg"></i>
            </button>
            
            <!-- Chat Toggle -->
            <button onclick="app.toggleChat()" class="w-10 h-10 rounded-full bg-slate-900 dark:bg-blue-600 text-white flex items-center justify-center shadow-lg shadow-slate-300 dark:shadow-blue-900/30 hover:scale-110 transition-transform active:scale-90">
                <i class="ph ph-sparkle-fill text-yellow-400 dark:text-white text-lg"></i>
            </button>
        </div>
    </header>

    <!-- MAIN SCROLL AREA -->
    <main id="main-scroll" class="flex-1 overflow-y-auto overflow-x-hidden pt-24 pb-32 px-4 md:px-6 w-full max-w-3xl mx-auto scroll-smooth no-scrollbar">
        
        <!-- ================= VIEW: DASHBOARD ================= -->
        <div id="view-dashboard" class="space-y-6 animate-in">
            
            <!-- Hero School Card -->
            <div class="relative bg-slate-900 dark:bg-slate-800 rounded-[2.5rem] p-8 overflow-hidden shadow-2xl group touch-card border border-slate-800 dark:border-slate-700">
                <!-- Decorative BG -->
                <div class="absolute -right-10 -top-10 w-64 h-64 bg-blue-600/20 rounded-full blur-3xl group-hover:bg-blue-500/30 transition-colors duration-700"></div>
                <div class="absolute bottom-0 right-0 p-6 opacity-10">
                    <svg width="100" height="100" viewBox="0 0 36 36" fill="white"><path d="M18 6L21 18L18 22L15 18L18 6Z"/></svg>
                </div>

                <div class="relative z-10">
                    <div class="inline-flex items-center gap-2 bg-white/10 backdrop-blur-md px-3 py-1.5 rounded-full border border-white/10 mb-4">
                        <i class="ph ph-shield-check-fill text-yellow-400"></i>
                        <span class="text-[10px] font-bold text-white uppercase tracking-wider">Ambiente Seguro</span>
                    </div>
                    <h2 class="text-3xl font-black text-white leading-tight mb-2">Consultor<br/><span class="text-blue-400">Digital</span></h2>
                    <p class="text-slate-400 text-sm font-medium max-w-[200px] leading-relaxed">
                        Apoio √† decis√£o, protocolos de seguran√ßa e rede de prote√ß√£o em um s√≥ lugar.
                    </p>
                </div>
            </div>

            <!-- Quick Actions Grid -->
            <div class="grid grid-cols-2 gap-4">
                <button onclick="app.startFlow()" class="glass-card p-6 rounded-[2rem] flex flex-col items-center gap-3 text-center touch-card group dark:hover:bg-slate-800/50 transition-colors">
                    <div class="w-14 h-14 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-2xl flex items-center justify-center text-3xl group-hover:scale-110 transition-transform">üß≠</div>
                    <div>
                        <h3 class="font-black text-slate-900 dark:text-white text-sm">Iniciar Fluxo</h3>
                        <p class="text-[10px] text-slate-500 dark:text-slate-400 font-bold uppercase tracking-wide mt-1">Decisor de Risco</p>
                    </div>
                </button>

                <button onclick="app.showNetwork()" class="glass-card p-6 rounded-[2rem] flex flex-col items-center gap-3 text-center touch-card group dark:hover:bg-slate-800/50 transition-colors">
                    <div class="w-14 h-14 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-2xl flex items-center justify-center text-3xl group-hover:scale-110 transition-transform">üó∫Ô∏è</div>
                    <div>
                        <h3 class="font-black text-slate-900 dark:text-white text-sm">Rede Local</h3>
                        <p class="text-[10px] text-slate-500 dark:text-slate-400 font-bold uppercase tracking-wide mt-1">Mapa & Contatos</p>
                    </div>
                </button>

                <button onclick="app.showLibrary()" class="glass-card p-6 rounded-[2rem] flex flex-col items-center gap-3 text-center touch-card group dark:hover:bg-slate-800/50 transition-colors">
                    <div class="w-14 h-14 bg-amber-50 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 rounded-2xl flex items-center justify-center text-3xl group-hover:scale-110 transition-transform">üìÇ</div>
                    <div>
                        <h3 class="font-black text-slate-900 dark:text-white text-sm">Recursos</h3>
                        <p class="text-[10px] text-slate-500 dark:text-slate-400 font-bold uppercase tracking-wide mt-1">Documentos</p>
                    </div>
                </button>

                <button onclick="app.showPrivacy()" class="glass-card p-6 rounded-[2rem] flex flex-col items-center gap-3 text-center touch-card group dark:hover:bg-slate-800/50 transition-colors">
                    <div class="w-14 h-14 bg-purple-50 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 rounded-2xl flex items-center justify-center text-3xl group-hover:scale-110 transition-transform">üé≠</div>
                    <div>
                        <h3 class="font-black text-slate-900 dark:text-white text-sm">Privacidade</h3>
                        <p class="text-[10px] text-slate-500 dark:text-slate-400 font-bold uppercase tracking-wide mt-1">Editor LGPD</p>
                    </div>
                </button>
            </div>

            <!-- Emergency Button -->
            <button onclick="app.triggerEmergency()" class="w-full bg-red-500 text-white p-1 rounded-[2.5rem] shadow-xl shadow-red-500/30 group active:scale-95 transition-all">
                <div class="border-2 border-white/20 rounded-[2.2rem] p-5 flex items-center justify-between bg-red-500">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-2xl animate-pulse">üö®</div>
                        <div class="text-left">
                            <h4 class="font-black text-lg uppercase tracking-tight">Emerg√™ncia</h4>
                            <p class="text-white/90 text-xs font-bold">Risco de vida ou crime em curso</p>
                        </div>
                    </div>
                    <i class="ph ph-caret-right-bold text-2xl group-hover:translate-x-1 transition-transform"></i>
                </div>
            </button>
        </div>

        <!-- ================= VIEW: SELECTION ================= -->
        <div id="view-selection" class="hidden space-y-6 animate-up">
            <div class="flex items-center gap-2 mb-2">
                <button onclick="app.goBack()" class="w-8 h-8 rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700">
                    <i class="ph ph-arrow-left-bold"></i>
                </button>
                <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Passo <span id="step-number">1</span> de 3</span>
            </div>

            <div class="text-left px-1">
                <h2 id="selection-title" class="text-3xl font-black text-slate-900 dark:text-white leading-tight">Qual a natureza<br/>da ocorr√™ncia?</h2>
                <p id="selection-subtitle" class="text-slate-500 dark:text-slate-400 font-medium mt-2 text-sm">Selecione a categoria para filtrar os protocolos.</p>
            </div>

            <div id="selection-grid" class="grid grid-cols-1 gap-4">
                <!-- Dynamic Content -->
            </div>
        </div>

        <!-- ================= VIEW: ACTION PLAN ================= -->
        <div id="view-action" class="hidden space-y-6 animate-up">
            <div id="action-card" class="rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden transition-colors duration-500">
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-6">
                        <button onclick="app.goBack()" class="bg-white/20 hover:bg-white/30 p-2 rounded-full backdrop-blur-md transition-colors">
                            <i class="ph ph-arrow-left-bold text-white"></i>
                        </button>
                        <span id="risk-badge" class="px-3 py-1.5 rounded-full bg-white text-[10px] font-black uppercase tracking-widest text-slate-900 shadow-lg">Risco Alto</span>
                    </div>
                    <h2 id="action-title" class="text-2xl font-black leading-tight mb-2">T√≠tulo do Protocolo</h2>
                    <p id="action-desc" class="text-white/90 text-sm font-medium leading-relaxed">Descri√ß√£o curta do cen√°rio.</p>
                </div>
            </div>

            <div class="glass-card p-6 rounded-[2rem]">
                <div class="flex items-center gap-3 mb-6 pb-4 border-b border-slate-100 dark:border-slate-700">
                    <div class="w-8 h-8 rounded-xl bg-slate-900 dark:bg-white text-white dark:text-slate-900 flex items-center justify-center font-bold text-sm">1</div>
                    <h3 class="font-black text-slate-900 dark:text-white text-sm uppercase tracking-widest">Plano de A√ß√£o</h3>
                </div>
                <div id="action-steps" class="space-y-4"></div>
            </div>

            <div class="glass-card p-6 rounded-[2rem] border-2 border-dashed border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/50">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-black text-[10px] text-slate-400 uppercase tracking-widest flex items-center gap-1">
                        <i class="ph ph-chat-centered-text text-lg"></i> O que dizer
                    </h4>
                    <button onclick="app.copyScript()" class="text-blue-600 dark:text-blue-400 text-xs font-bold hover:bg-blue-50 dark:hover:bg-blue-900/30 px-3 py-1 rounded-full transition-colors">Copiar</button>
                </div>
                <p id="action-script" class="text-slate-700 dark:text-slate-300 font-medium italic text-sm leading-relaxed">"..."</p>
            </div>

            <div class="glass-card p-6 rounded-[2rem] bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm">
                <h4 class="font-black text-[10px] text-slate-900 dark:text-white uppercase tracking-widest mb-4">Confirma√ß√£o de Seguran√ßa</h4>
                <div id="action-checks" class="space-y-3"></div>
                <button id="btn-finish" onclick="app.finishProtocol()" disabled class="mt-6 w-full py-4 rounded-2xl font-black text-xs uppercase tracking-widest bg-slate-100 dark:bg-slate-700 text-slate-400 transition-all duration-300 flex items-center justify-center gap-2">
                    <span>Validar Procedimentos</span>
                </button>
            </div>

            <div id="action-service-container"></div>
        </div>

        <!-- ================= VIEW: NETWORK (Map & List) ================= -->
        <div id="view-network" class="hidden space-y-6 animate-up h-full flex flex-col">
            <div class="flex items-center justify-between px-2 shrink-0">
                <div>
                    <h2 class="text-2xl font-black text-slate-900 dark:text-white">Rede de<br/>Prote√ß√£o</h2>
                </div>
                <div class="flex gap-2">
                    <button onclick="app.toggleMapView()" id="btn-map-toggle" class="w-12 h-12 bg-white dark:bg-slate-800 text-slate-900 dark:text-white border border-slate-200 dark:border-slate-700 rounded-2xl flex items-center justify-center text-xl shadow-sm hover:scale-105 transition-transform">
                        <i class="ph ph-map-trifold"></i>
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar px-1 shrink-0">
                <button onclick="app.filterNetwork('all')" class="network-filter active px-5 py-2.5 rounded-full text-xs font-bold transition-all bg-slate-900 dark:bg-white text-white dark:text-slate-900 shadow-lg">Todos</button>
                <button onclick="app.filterNetwork('saude')" class="network-filter px-5 py-2.5 rounded-full text-xs font-bold transition-all bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">Sa√∫de</button>
                <button onclick="app.filterNetwork('protecao')" class="network-filter px-5 py-2.5 rounded-full text-xs font-bold transition-all bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">Prote√ß√£o</button>
                <button onclick="app.filterNetwork('assistencia')" class="network-filter px-5 py-2.5 rounded-full text-xs font-bold transition-all bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">Social</button>
            </div>

            <!-- List Container -->
            <div id="network-list" class="space-y-3 pb-8"></div>

            <!-- Map Container (Hidden by default) -->
            <div id="network-map-container" class="hidden h-full pb-8">
                <div class="map-wrapper border-4 border-white dark:border-slate-700">
                    <div id="map"></div>
                </div>
            </div>
        </div>

        <!-- ================= VIEW: LIBRARY ================= -->
        <div id="view-library" class="hidden space-y-6 animate-up">
            <div class="flex items-center justify-between px-2">
                <h2 class="text-2xl font-black text-slate-900 dark:text-white">Documentos<br/>Oficiais</h2>
                <div class="w-12 h-12 bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 rounded-2xl flex items-center justify-center text-2xl">üìÇ</div>
            </div>
            <p class="text-slate-500 dark:text-slate-400 text-sm font-medium px-2">Baixe e imprima os modelos obrigat√≥rios.</p>
            <div id="resources-list" class="space-y-3 pb-8"></div>
        </div>

        <!-- ================= VIEW: PRIVACY EDITOR ================= -->
        <div id="view-privacy" class="hidden space-y-6 animate-up">
            <div class="flex items-center gap-2 mb-2">
                <button onclick="app.goHome()" class="text-purple-600 dark:text-purple-400 font-bold text-sm flex items-center gap-1"><i class="ph ph-arrow-left"></i> Voltar</button>
            </div>
            <h2 class="text-2xl font-black text-slate-900 dark:text-white">Editor LGPD</h2>

            <div class="glass-card p-8 rounded-[2.5rem] border-2 border-dashed border-slate-300 dark:border-slate-600 text-center hover:border-purple-400 transition-colors cursor-pointer" onclick="document.getElementById('file-upload').click()" id="drop-zone">
                <input type="file" id="file-upload" accept="image/*" class="hidden" onchange="privacy.handleFile(this)">
                <div class="w-16 h-16 bg-purple-50 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 rounded-full flex items-center justify-center text-3xl mx-auto mb-4">
                    <i class="ph ph-camera-plus"></i>
                </div>
                <h3 class="font-black text-slate-900 dark:text-white text-sm">Adicionar Evid√™ncia</h3>
                <p class="text-slate-500 dark:text-slate-400 text-xs mt-1">Carregue foto para anonimiza√ß√£o</p>
            </div>

            <div id="editor-ui" class="hidden space-y-4">
                <div class="relative rounded-2xl overflow-hidden shadow-lg bg-slate-900 min-h-[200px] flex items-center justify-center">
                    <canvas id="privacy-canvas" class="max-w-full"></canvas>
                    <div id="privacy-loader" class="absolute inset-0 bg-black/60 flex flex-col items-center justify-center hidden">
                        <i class="ph ph-spinner animate-spin text-white text-3xl mb-2"></i>
                        <span class="text-white text-[10px] font-black uppercase tracking-widest">Processando IA...</span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="privacy.applyBlur()" class="bg-purple-600 text-white py-3.5 rounded-xl font-bold text-xs uppercase tracking-wide shadow-lg shadow-purple-200 flex items-center justify-center gap-2 active:scale-95 transition-transform">
                        <i class="ph ph-magic-wand"></i> Anonimizar
                    </button>
                    <button onclick="privacy.download()" class="bg-slate-900 text-white py-3.5 rounded-xl font-bold text-xs uppercase tracking-wide shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform">
                        <i class="ph ph-download-simple"></i> Baixar
                    </button>
                </div>
                <p class="text-center text-[10px] text-slate-400">A imagem original n√£o √© salva no servidor.</p>
            </div>
        </div>

        <!-- ================= VIEW: SUCCESS ================= -->
        <div id="view-success" class="hidden space-y-6 animate-up">
            <div class="glass-card p-10 rounded-[3rem] text-center border-t-4 border-green-500">
                <div class="w-20 h-20 bg-green-50 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-3xl flex items-center justify-center text-4xl mx-auto mb-6 shadow-sm">
                    <i class="ph ph-check-fat-fill"></i>
                </div>
                <h2 class="text-2xl font-black text-slate-900 dark:text-white mb-2">Protocolo Conclu√≠do</h2>
                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium leading-relaxed mb-6">
                    As etapas foram validadas. Utilize o resumo abaixo para preencher a Ficha de Acolhimento F√≠sica.
                </p>
                <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 text-left mb-6 relative group">
                    <textarea readonly id="final-summary" class="w-full bg-transparent text-xs font-mono text-slate-600 dark:text-slate-300 resize-none outline-none h-32"></textarea>
                    <button onclick="app.copySummary()" class="absolute top-2 right-2 bg-white dark:bg-slate-800 p-2 rounded-lg shadow-sm text-slate-400 hover:text-blue-600 transition-colors">
                        <i class="ph ph-copy"></i>
                    </button>
                </div>
                <button onclick="app.goHome()" class="w-full bg-slate-900 dark:bg-blue-600 text-white py-4 rounded-2xl font-black text-sm active:scale-95 transition-transform">
                    Voltar ao In√≠cio
                </button>
            </div>
        </div>

    </main>

    <!-- BOTTOM NAV -->
    <nav class="fixed bottom-6 left-6 right-6 h-20 glass-panel rounded-[2.5rem] shadow-2xl z-40 flex items-center justify-around px-2 max-w-md mx-auto">
        <button onclick="app.goHome()" class="nav-item group active w-16 h-full flex flex-col items-center justify-center gap-1" data-target="dashboard">
            <i class="ph ph-house-fill text-2xl text-slate-300 group-[.active]:text-slate-900 dark:group-[.active]:text-white transition-colors"></i>
            <span class="text-[9px] font-black uppercase text-slate-900 dark:text-white opacity-0 group-[.active]:opacity-100 transition-opacity transform translate-y-2 group-[.active]:translate-y-0">In√≠cio</span>
        </button>
        <button onclick="app.startFlow()" class="nav-item group w-16 h-full flex flex-col items-center justify-center gap-1" data-target="selection">
            <i class="ph ph-compass-fill text-2xl text-slate-300 group-[.active]:text-blue-600 dark:group-[.active]:text-blue-400 transition-colors"></i>
        </button>
        <button onclick="app.showNetwork()" class="nav-item group w-16 h-full flex flex-col items-center justify-center gap-1" data-target="network">
            <i class="ph ph-map-trifold-fill text-2xl text-slate-300 group-[.active]:text-emerald-600 dark:group-[.active]:text-emerald-400 transition-colors"></i>
        </button>
        <button onclick="app.showLibrary()" class="nav-item group w-16 h-full flex flex-col items-center justify-center gap-1" data-target="library">
            <i class="ph ph-files-fill text-2xl text-slate-300 group-[.active]:text-amber-600 dark:group-[.active]:text-amber-400 transition-colors"></i>
        </button>
    </nav>

    <!-- CHAT PANEL -->
    <div id="chat-panel" class="fixed inset-y-0 right-0 w-full md:w-[400px] bg-white dark:bg-slate-900 shadow-2xl z-[60] transform translate-x-full transition-transform duration-300 flex flex-col">
        <div class="h-safe-top bg-slate-900 dark:bg-black/20"></div>
        <div class="bg-slate-900 dark:bg-slate-800 p-6 text-white flex items-center justify-between shadow-lg z-10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center">
                    <i class="ph ph-sparkle-fill text-yellow-400 text-xl"></i>
                </div>
                <div>
                    <h3 class="font-black text-sm uppercase tracking-widest">Consultor IA</h3>
                    <p class="text-[10px] text-slate-400 font-medium">Suporte 24h sobre o protocolo</p>
                </div>
            </div>
            <button onclick="app.toggleChat()" class="p-2 hover:bg-white/10 rounded-full transition-colors"><i class="ph ph-x text-xl"></i></button>
        </div>

        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 dark:bg-slate-950">
            <div class="flex gap-3">
                <div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center shrink-0"><i class="ph ph-robot-fill"></i></div>
                <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 dark:border-slate-700 text-sm text-slate-600 dark:text-slate-300 leading-relaxed">
                    Ol√°! Sou o assistente inteligente da B√∫ssola. Descreva a situa√ß√£o e eu ajudarei a encontrar o protocolo correto ou sugerir a√ß√µes seguras.
                </div>
            </div>
        </div>

        <div class="p-4 bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 space-y-3 pb-8">
            <input type="password" id="api-key" class="w-full text-[10px] bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-slate-500 focus:outline-none focus:border-purple-500 transition-colors" placeholder="Gemini API Key (Opcional)">
            <div class="flex gap-2 relative">
                <input type="text" id="chat-input" class="flex-1 bg-slate-100 dark:bg-slate-800 border-none rounded-2xl px-5 py-4 text-sm font-medium focus:ring-2 focus:ring-slate-900 dark:focus:ring-blue-500 outline-none placeholder-slate-400 dark:text-white" placeholder="Digite sua d√∫vida..." onkeypress="if(event.key === 'Enter') app.sendChat()">
                <button onclick="app.sendChat()" class="absolute right-2 top-2 bottom-2 bg-slate-900 dark:bg-blue-600 text-white w-10 rounded-xl flex items-center justify-center hover:scale-95 transition-transform shadow-lg">
                    <i class="ph ph-paper-plane-right-fill"></i>
                </button>
            </div>
        </div>
    </div>
    <div id="chat-overlay" onclick="app.toggleChat()" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden opacity-0 transition-opacity duration-300"></div>

    <script>
        // --- DATA ---
        const DB = {
            areas: [
                { id: 'saude-mental', icon: 'üß†', title: 'Sa√∫de Mental', desc: 'Ansiedade, idea√ß√£o suicida', color: 'border-blue-500', iconColor: 'text-blue-600', bg: 'bg-blue-50 dark:bg-blue-900/30' },
                { id: 'violencia', icon: '‚ö†Ô∏è', title: 'Viol√™ncia', desc: 'Abuso, neglig√™ncia, direitos', color: 'border-red-500', iconColor: 'text-red-600', bg: 'bg-red-50 dark:bg-red-900/30' },
                { id: 'vulnerabilidade-social', icon: 'üè†', title: 'Vulnerabilidade', desc: 'Fome, abrigo, pobreza', color: 'border-yellow-500', iconColor: 'text-yellow-600', bg: 'bg-yellow-50 dark:bg-yellow-900/30' },
                { id: 'pedagogica', icon: 'üéì', title: 'Pedag√≥gico', desc: 'Evas√£o, conflitos', color: 'border-purple-500', iconColor: 'text-purple-600', bg: 'bg-purple-50 dark:bg-purple-900/30' }
            ],
            scenarios: {
                'violencia': [
                    { id: 'v1', title: 'Viol√™ncia F√≠sica Recente', desc: 'Hematomas, les√µes ou fraturas.', risk: 'Urg√™ncia', theme: 'bg-red-600', steps: ['Isolamento seguro', 'Comunica√ß√£o IMEDIATA', 'Acionar CT (24h)', 'N√£o investigar'], script: 'Eu acredito em voc√™. Voc√™ est√° seguro agora. Preciso chamar a Dire√ß√£o para te proteger.', checks: ['Aluno isolado?', 'Dire√ß√£o avisada?', 'CT acionado?'], service: 'ct' },
                    { id: 'v2', title: 'Abuso Sexual (Suspeita)', desc: 'Relato de toque inadequado.', risk: 'Urg√™ncia', theme: 'bg-red-600', steps: ['Comunica√ß√£o IMEDIATA', 'Proteger a crian√ßa', 'Acionar CT e DDM'], script: 'Voc√™ foi muito corajoso em contar. √â meu dever proteger voc√™, por isso vou chamar quem pode ajudar.', checks: ['N√£o interrogou?', 'CT acionado?', 'Sigilo garantido?'], service: 'ct' }
                ],
                'saude-mental': [
                    { id: 's3', title: 'Idea√ß√£o Suicida Ativa', desc: 'Plano estruturado, acesso a meios.', risk: 'Urg√™ncia', theme: 'bg-red-600', steps: ['NUNCA deixar sozinho', 'Acionar Dire√ß√£o e SAMU', 'Contatar fam√≠lia'], script: 'Estou aqui com voc√™. N√£o vou sair do seu lado. O m√©dico est√° vindo ajudar.', checks: ['Supervis√£o constante?', 'SAMU chamado?', 'Fam√≠lia avisada?'], service: 'samu' },
                    { id: 's2', title: 'Automutila√ß√£o Frequente', desc: 'Cortes, queimaduras.', risk: 'Alto', theme: 'bg-orange-500', steps: ['Acolhimento emp√°tico', 'Comunicar respons√°veis', 'Encaminhar CAPS'], script: 'Percebi que voc√™ est√° machucado. Quero te ajudar. N√£o vou contar para a sala toda, mas preciso avisar sua m√£e.', checks: ['Aluno calmo?', 'Fam√≠lia avisada?', 'CAPS orientado?'], service: 'caps' }
                ]
            }
        };

        const CONTACTS = [
            { id: 'escola', name: 'E.E. Ermelino Matarazzo', type: 'protecao', tel: '(11) 2943-7188', address: 'Rua Abel Tavares, s/n', urgency: false, lat: -23.4947, lng: -46.4719 },
            { id: 'ct', name: 'Conselho Tutelar', type: 'protecao', tel: '(11) 2545-5159', address: 'Av. Milene Elias, 417', urgency: true, lat: -23.4883, lng: -46.4842 },
            { id: 'pm', name: 'Pol√≠cia Militar', type: 'protecao', tel: '190', address: 'Emerg√™ncia', urgency: true, lat: -23.4900, lng: -46.4800 },
            { id: 'delegacia', name: '4¬™ DDM (Mulher)', type: 'justica', tel: '(11) 2041-3535', address: 'Rua Dr. Corinto Baldo√≠no Costa, 400', urgency: false, lat: -23.5188, lng: -46.5414 },
            { id: 'creas', name: 'CREAS Ermelino', type: 'assistencia', tel: '(11) 2545-3211', address: 'Av. Paranagu√°, 1492', urgency: false, lat: -23.4934, lng: -46.4812 },
            { id: 'cras', name: 'CRAS Ermelino', type: 'assistencia', tel: '(11) 2545-3211', address: 'Av. Paranagu√°, 1492', urgency: false, lat: -23.4934, lng: -46.4812 },
            { id: 'ong-acolher', name: 'ONG Semente da Esperan√ßa', type: 'assistencia', tel: '(11) 2546-1020', address: 'Entorno da Escola', urgency: false, lat: -23.4950, lng: -46.4730 },
            { id: 'samu', name: 'SAMU', type: 'saude', tel: '192', address: 'Emerg√™ncia', urgency: true, lat: -23.4910, lng: -46.4780 },
            { id: 'caps', name: 'CAPS IJ', type: 'saude', tel: '(11) 3294-3828', address: 'Rua Antonio Bonici, 18', urgency: false, lat: -23.4855, lng: -46.4788 },
            { id: 'ubs', name: 'UBS Jardim Bel√©m', type: 'saude', tel: '(11) 2545-8235', address: 'Rua Ant√¥nio de Freitas Toledo, 185', urgency: false, lat: -23.4975, lng: -46.4745 }
        ];

        const RESOURCES = [
            { id: 'anexo-1', title: 'Anexo I - Ficha de Acolhimento', desc: 'Registro confidencial da demanda.', format: 'PDF', required: true, url: '#' },
            { id: 'anexo-3', title: 'Anexo III - Encaminhamento Externo', desc: 'Guia para envio a servi√ßos.', format: 'DOCX', required: true, url: '#' },
            { id: 'anexo-5', title: 'Anexo V - Registro ECA Art. 13', desc: 'Of√≠cio de comunica√ß√£o de viol√™ncia.', format: 'DOCX', required: true, url: '#' },
            { id: 'anexo-6', title: 'Anexo VI - Sa√∫de Mental e Risco', desc: 'Avalia√ß√£o de idea√ß√£o suicida.', format: 'PDF', required: true, url: '#' }
        ];

        let mapInstance = null;

        // --- APP CONTROLLER ---
        const app = {
            state: { view: 'dashboard', area: null, scenario: null, isDark: false },

            toggleTheme: () => {
                app.state.isDark = !app.state.isDark;
                document.documentElement.classList.toggle('dark');
                const icon = document.getElementById('theme-icon');
                icon.className = app.state.isDark ? 'ph ph-sun-fill text-lg' : 'ph ph-moon-fill text-lg';
            },

            // Navigation
            goHome: () => { app.switchView('dashboard'); },
            startFlow: () => { app.renderAreas(); app.switchView('selection'); },
            
            switchView: (viewId) => {
                document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${viewId}`).classList.remove('hidden');
                
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                
                let navTarget = 'dashboard';
                if(['selection', 'action'].includes(viewId)) navTarget = 'selection';
                if(viewId === 'network') navTarget = 'network';
                if(viewId === 'privacy') navTarget = 'privacy';
                if(viewId === 'library') navTarget = 'library';
                
                const activeNav = document.querySelector(`.nav-item[data-target="${navTarget}"]`);
                if(activeNav) activeNav.classList.add('active');

                app.state.view = viewId;
                window.scrollTo(0,0);
            },

            // Areas & Scenarios
            renderAreas: () => {
                const grid = document.getElementById('selection-grid');
                grid.innerHTML = DB.areas.map(area => `
                    <button onclick="app.selectArea('${area.id}')" class="glass-card p-5 rounded-[2rem] flex items-center gap-5 border-l-[6px] ${area.color} touch-card group hover:bg-slate-50 dark:hover:bg-slate-800 text-left transition-colors">
                        <div class="w-12 h-12 rounded-2xl ${area.bg} flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                            ${area.icon}
                        </div>
                        <div>
                            <h3 class="font-black text-slate-900 dark:text-white text-lg">${area.title}</h3>
                            <p class="text-xs text-slate-500 dark:text-slate-400 font-medium">${area.desc}</p>
                        </div>
                    </button>
                `).join('');
                document.getElementById('step-number').innerText = "1";
            },

            selectArea: (areaId) => {
                app.state.area = areaId;
                const grid = document.getElementById('selection-grid');
                const scenarios = DB.scenarios[areaId] || [];
                grid.innerHTML = scenarios.map(scen => `
                    <button onclick="app.loadScenario('${areaId}', '${scen.id}')" class="glass-card p-6 rounded-[2rem] text-left touch-card border border-slate-100 dark:border-slate-700 hover:border-slate-300">
                        <div class="flex justify-between items-start mb-2">
                            <span class="px-2 py-1 rounded-md bg-slate-100 dark:bg-slate-700 text-[10px] font-black uppercase text-slate-600 dark:text-slate-300 tracking-wider">Risco ${scen.risk}</span>
                            <i class="ph ph-caret-right-bold text-slate-300"></i>
                        </div>
                        <h3 class="font-black text-slate-900 dark:text-white text-lg mb-1">${scen.title}</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 font-medium leading-snug">${scen.desc}</p>
                    </button>
                `).join('');
                document.getElementById('step-number').innerText = "2";
            },

            loadScenario: (areaId, scenId) => {
                const scen = DB.scenarios[areaId].find(s => s.id === scenId);
                app.state.scenario = scen;
                
                const card = document.getElementById('action-card');
                card.className = `rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden transition-colors duration-500 ${scen.theme}`;
                document.getElementById('action-title').innerText = scen.title;
                document.getElementById('action-desc').innerText = scen.desc;
                document.getElementById('risk-badge').innerText = `Risco ${scen.risk}`;
                
                document.getElementById('action-steps').innerHTML = scen.steps.map((step, i) => `
                    <div class="flex items-start gap-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-100 dark:border-slate-700">
                        <span class="text-[10px] font-black text-slate-400 mt-1">${i+1}</span>
                        <p class="text-sm text-slate-700 dark:text-slate-300 font-medium leading-relaxed">${step}</p>
                    </div>`).join('');
                
                document.getElementById('action-script').innerText = `"${scen.script}"`;
                document.getElementById('action-checks').innerHTML = scen.checks.map(c => `
                    <label class="flex items-center gap-3 p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-100 dark:border-slate-700 cursor-pointer touch-card">
                        <input type="checkbox" class="w-5 h-5 rounded text-slate-900 focus:ring-slate-900 checkbox-audit" onchange="app.validateChecks()">
                        <span class="text-xs font-bold text-slate-700 dark:text-slate-300 select-none">${c}</span>
                    </label>`).join('');

                const contact = CONTACTS.find(c => c.id === scen.service);
                document.getElementById('action-service-container').innerHTML = contact ? `
                    <div class="mt-6 glass-card p-5 rounded-[2rem] flex items-center justify-between border-l-4 ${contact.urgency ? 'border-red-500' : 'border-blue-500'}">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl ${contact.urgency ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-600'}">
                                ${contact.urgency ? 'üö®' : 'üìç'}
                            </div>
                            <div>
                                <h4 class="font-black text-slate-900 dark:text-white text-sm tracking-tight">${contact.name}</h4>
                                <p class="text-slate-500 text-[10px] font-bold uppercase">Acionamento Recomendado</p>
                            </div>
                        </div>
                        <a href="tel:${contact.tel.replace(/\D/g,'')}" class="w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-transform active:scale-90 ${contact.urgency ? 'bg-red-500 text-white' : 'bg-slate-900 dark:bg-white dark:text-slate-900 text-white'}">
                            <i class="ph ph-phone-fill text-xl"></i>
                        </a>
                    </div>` : '';

                const btn = document.getElementById('btn-finish');
                btn.disabled = true;
                btn.className = "mt-6 w-full py-4 rounded-2xl font-black text-xs uppercase tracking-widest bg-slate-100 dark:bg-slate-700 text-slate-400 cursor-not-allowed transition-all";
                btn.innerHTML = '<span>Validar Procedimentos</span>';

                app.switchView('action');
            },

            validateChecks: () => {
                const total = document.querySelectorAll('.checkbox-audit').length;
                const checked = document.querySelectorAll('.checkbox-audit:checked').length;
                const btn = document.getElementById('btn-finish');
                if (total > 0 && total === checked) {
                    btn.disabled = false;
                    btn.className = "mt-6 w-full py-4 rounded-2xl font-black text-xs uppercase tracking-widest bg-green-500 text-white shadow-xl shadow-green-200 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2";
                    btn.innerHTML = '<i class="ph ph-check-circle text-lg"></i> <span>Registrar Protocolo</span>';
                }
            },

            finishProtocol: () => {
                const summary = `PROTOCOLO: ${app.state.scenario.title}\nRISCO: ${app.state.scenario.risk}\nDATA: ${new Date().toLocaleString()}\nA√á√ïES REALIZADAS:\n- ${app.state.scenario.steps.join('\n- ')}`;
                document.getElementById('final-summary').value = summary;
                app.switchView('success');
            },

            goBack: () => {
                if (app.state.view === 'action') { app.selectArea(app.state.area); }
                else if (app.state.view === 'selection' && app.state.area) { app.startFlow(); app.state.area = null; }
                else { app.goHome(); }
            },

            // --- NETWORK & MAP ---
            showNetwork: () => { app.filterNetwork('all'); app.switchView('network'); },
            
            filterNetwork: (type) => {
                document.querySelectorAll('.network-filter').forEach(b => {
                    b.classList.remove('bg-slate-900', 'text-white', 'dark:bg-white', 'dark:text-slate-900', 'shadow-lg');
                    b.classList.add('bg-white', 'text-slate-600', 'border', 'dark:bg-slate-800', 'dark:text-slate-300');
                });
                if(event) {
                    event.target.classList.remove('bg-white', 'text-slate-600', 'border', 'dark:bg-slate-800');
                    event.target.classList.add('bg-slate-900', 'text-white', 'dark:bg-white', 'dark:text-slate-900', 'shadow-lg');
                }

                const list = document.getElementById('network-list');
                const filtered = type === 'all' ? CONTACTS : CONTACTS.filter(c => c.type === type);

                list.innerHTML = filtered.map(c => `
                    <div class="glass-card p-5 rounded-[2rem] flex items-center justify-between touch-card dark:border-slate-700">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl ${c.urgency ? 'bg-red-50 text-red-600' : 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300'}">
                                ${c.urgency ? 'üö®' : 'üìû'}
                            </div>
                            <div>
                                <h4 class="font-black text-slate-900 dark:text-white text-sm tracking-tight">${c.name}</h4>
                                <div class="flex flex-col">
                                    <span class="text-slate-500 dark:text-slate-400 text-[10px] font-bold">${c.tel}</span>
                                    ${c.address ? `<span class="text-slate-400 text-[9px] truncate max-w-[150px]">${c.address}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <a href="tel:${c.tel.replace(/\D/g,'')}" class="w-10 h-10 rounded-full bg-slate-900 dark:bg-white dark:text-slate-900 text-white flex items-center justify-center shadow-lg active:scale-90 transition-transform">
                            <i class="ph ph-phone-fill"></i>
                        </a>
                    </div>
                `).join('');
                
                // Update map if visible
                if (mapInstance && !document.getElementById('network-map-container').classList.contains('hidden')) {
                    app.initMap(filtered);
                }
            },

            toggleMapView: () => {
                const list = document.getElementById('network-list');
                const mapContainer = document.getElementById('network-map-container');
                const btn = document.getElementById('btn-map-toggle');
                
                if (mapContainer.classList.contains('hidden')) {
                    list.classList.add('hidden');
                    mapContainer.classList.remove('hidden');
                    btn.innerHTML = '<i class="ph ph-list-dashes"></i>';
                    btn.classList.add('bg-slate-900', 'text-white', 'dark:bg-blue-600');
                    btn.classList.remove('bg-white', 'dark:bg-slate-800');
                    app.initMap(CONTACTS); // Init with all by default
                } else {
                    mapContainer.classList.add('hidden');
                    list.classList.remove('hidden');
                    btn.innerHTML = '<i class="ph ph-map-trifold"></i>';
                    btn.classList.remove('bg-slate-900', 'text-white', 'dark:bg-blue-600');
                    btn.classList.add('bg-white', 'dark:bg-slate-800');
                }
            },

            initMap: (data) => {
                if (!mapInstance) {
                    mapInstance = L.map('map').setView([-23.4947, -46.4719], 14);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                        subdomains: 'abcd',
                        maxZoom: 20
                    }).addTo(mapInstance);
                }
                
                // Clear existing layers
                mapInstance.eachLayer((layer) => {
                    if (layer instanceof L.Marker) mapInstance.removeLayer(layer);
                });

                data.forEach(c => {
                    if (c.lat && c.lng) {
                        const iconHtml = `<div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm shadow-lg border-2 border-white ${c.urgency ? 'bg-red-500' : 'bg-blue-600'}">${c.urgency ? 'üö®' : 'üìç'}</div>`;
                        const customIcon = L.divIcon({
                            html: iconHtml,
                            className: 'bg-transparent',
                            iconSize: [32, 32],
                            iconAnchor: [16, 32],
                            popupAnchor: [0, -32]
                        });
                        
                        L.marker([c.lat, c.lng], { icon: customIcon })
                            .addTo(mapInstance)
                            .bindPopup(`<b>${c.name}</b><br>${c.tel}<br><a href="https://maps.google.com/?q=${c.lat},${c.lng}" target="_blank">Abrir no Google Maps</a>`);
                    }
                });
                
                setTimeout(() => mapInstance.invalidateSize(), 100);
            },

            // --- LIBRARY ---
            showLibrary: () => {
                const list = document.getElementById('resources-list');
                list.innerHTML = RESOURCES.map(r => `
                    <div class="glass-card p-5 rounded-[2rem] flex items-center justify-between touch-card group hover:border-amber-300 dark:hover:border-amber-700 transition-colors">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-amber-50 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 flex items-center justify-center text-xl font-black">
                                ${r.format}
                            </div>
                            <div>
                                <h4 class="font-black text-slate-900 dark:text-white text-sm tracking-tight">${r.title}</h4>
                                <p class="text-slate-500 dark:text-slate-400 text-[10px] font-medium max-w-[180px]">${r.desc}</p>
                            </div>
                        </div>
                        <a href="${r.url}" target="_blank" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-400 flex items-center justify-center group-hover:bg-slate-900 group-hover:text-white transition-colors">
                            <i class="ph ph-download-simple-bold"></i>
                        </a>
                    </div>
                `).join('');
                app.switchView('library');
            },

            // --- PRIVACY & OTHERS ---
            showPrivacy: () => app.switchView('privacy'),
            triggerEmergency: () => { app.switchView('selection'); app.selectArea('saude-mental'); app.loadScenario('saude-mental', 's3'); },
            copySummary: () => {
                const text = document.getElementById('final-summary').value;
                navigator.clipboard.writeText(text);
            },
            copyScript: () => {
                const text = document.getElementById('action-script').innerText.replace(/"/g, '');
                navigator.clipboard.writeText(text);
            },

            // --- CHAT IA ---
            toggleChat: () => {
                const panel = document.getElementById('chat-panel');
                const overlay = document.getElementById('chat-overlay');
                if (panel.classList.contains('translate-x-0')) {
                    panel.classList.remove('translate-x-0');
                    panel.classList.add('translate-x-full');
                    overlay.classList.add('opacity-0');
                    setTimeout(() => overlay.classList.add('hidden'), 300);
                } else {
                    overlay.classList.remove('hidden');
                    void overlay.offsetWidth;
                    overlay.classList.remove('opacity-0');
                    panel.classList.remove('translate-x-full');
                    panel.classList.add('translate-x-0');
                }
            },
            sendChat: async () => {
                const input = document.getElementById('chat-input');
                const msg = input.value.trim();
                const key = document.getElementById('api-key').value.trim();
                const container = document.getElementById('chat-messages');
                if (!msg) return;
                
                container.innerHTML += `<div class="flex gap-3 justify-end animate-in"><div class="bg-slate-900 dark:bg-blue-600 text-white p-4 rounded-2xl rounded-tr-none shadow-md text-sm max-w-[85%] font-medium">${msg}</div></div>`;
                input.value = '';
                container.scrollTop = container.scrollHeight;

                if (!key) {
                    container.innerHTML += `<div class="text-center text-[10px] font-bold text-red-500 my-2">API Key Necess√°ria</div>`;
                    return;
                }

                const loadId = 'load-' + Date.now();
                container.innerHTML += `<div id="${loadId}" class="flex gap-3 animate-in"><div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center shrink-0"><i class="ph ph-robot-fill"></i></div><div class="bg-white dark:bg-slate-800 p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 dark:border-slate-700"><i class="ph ph-dots-three animate-bounce text-slate-400"></i></div></div>`;
                container.scrollTop = container.scrollHeight;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: `Voc√™ √© o Consultor B√∫ssola. Responda curto e t√©cnico sobre protocolo escolar: "${msg}"` }] }] })
                    });
                    const data = await response.json();
                    document.getElementById(loadId).remove();
                    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Erro na resposta.";
                    container.innerHTML += `<div class="flex gap-3 animate-in"><div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center shrink-0"><i class="ph ph-robot-fill"></i></div><div class="bg-white dark:bg-slate-800 p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 dark:border-slate-700 prose prose-sm text-slate-600 dark:text-slate-300">${marked.parse(reply)}</div></div>`;
                } catch (e) {
                    document.getElementById(loadId).remove();
                    container.innerHTML += `<div class="text-center text-[10px] font-bold text-red-500">Erro de Conex√£o</div>`;
                }
                container.scrollTop = container.scrollHeight;
            }
        };

        const privacy = {
            handleFile: (input) => {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.getElementById('privacy-canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = 400; canvas.height = (img.height / img.width) * 400;
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            document.getElementById('drop-zone').classList.add('hidden');
                            document.getElementById('editor-ui').classList.remove('hidden');
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },
            applyBlur: () => {
                const loader = document.getElementById('privacy-loader');
                loader.classList.remove('hidden');
                setTimeout(() => {
                    const canvas = document.getElementById('privacy-canvas');
                    const ctx = canvas.getContext('2d');
                    ctx.globalAlpha = 0.9; ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.globalAlpha = 1.0;
                    ctx.fillStyle = "#1E293B"; ctx.font = "bold 24px Inter"; ctx.textAlign = "center";
                    ctx.fillText("ANONIMIZADO", canvas.width/2, canvas.height/2);
                    loader.classList.add('hidden');
                }, 1500);
            },
            download: () => {
                const link = document.createElement('a');
                link.download = 'evidencia-segura.png';
                link.href = document.getElementById('privacy-canvas').toDataURL();
                link.click();
            }
        };
    </script>
</body>
</html>
